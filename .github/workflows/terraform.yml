name: Terraform CI

on:
  push:
    branches: [ "dev", "qa", "prod" ]
  workflow_dispatch:

env:
  TF_DIR: terraform

jobs:
  validate:
    name: Terraform validate
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: 1.5.7

      - name: Terraform init & validate
        working-directory: ${{ env.TF_DIR }}
        run: |
          terraform init -input=false
          terraform validate

  plan:
    name: Terraform plan
    runs-on: ubuntu-latest
    needs: validate
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install deps (curl jq)
        run: |
          sudo apt-get update
          sudo apt-get install -y curl jq

      - name: Fetch secrets from Vault (AppRole)
        id: vault
        env:
          VAULT_ADDR: ${{ secrets.VAULT_ADDR }}
          VAULT_ROLE_ID: ${{ secrets.VAULT_ROLE_ID }}
          VAULT_SECRET_ID: ${{ secrets.VAULT_SECRET_ID }}
        run: |
          if [ -n "$VAULT_ADDR" ]; then
            resp=$(curl -s -X POST "$VAULT_ADDR/v1/auth/approle/login" -d "{\"role_id\":\"${VAULT_ROLE_ID}\",\"secret_id\":\"${VAULT_SECRET_ID}\"}")
            token=$(echo "$resp" | jq -r '.auth.client_token // empty')
            if [ -z "$token" ]; then echo "Vault login failed: $resp" && exit 1; fi
            secret_json=$(curl -s -H "X-Vault-Token: $token" "$VAULT_ADDR/v1/secret/data/figma-web-matcher/ci")
            export AWS_ACCESS_KEY_ID=$(echo "$secret_json" | jq -r '.data.data.AWS_ACCESS_KEY_ID // empty')
            export AWS_SECRET_ACCESS_KEY=$(echo "$secret_json" | jq -r '.data.data.AWS_SECRET_ACCESS_KEY // empty')
            export TF_PUB_KEY=$(echo "$secret_json" | jq -r '.data.data.TF_PUB_KEY // empty')
            export TF_VAR_key_name=$(echo "$secret_json" | jq -r '.data.data.TF_VAR_key_name // empty')
            export TF_VAR_github_repo=$(echo "$secret_json" | jq -r '.data.data.TF_VAR_github_repo // empty')
            export TF_VAR_app_port=$(echo "$secret_json" | jq -r '.data.data.TF_VAR_app_port // empty')
            export TF_VAR_aws_region=$(echo "$secret_json" | jq -r '.data.data.TF_VAR_aws_region // empty')
            echo "$TF_PUB_KEY" > /tmp/deploy_key.pub
            echo "AWS_ACCESS_KEY_ID=$AWS_ACCESS_KEY_ID" >> $GITHUB_ENV
            echo "AWS_SECRET_ACCESS_KEY=$AWS_SECRET_ACCESS_KEY" >> $GITHUB_ENV
            echo "TF_VAR_key_name=$TF_VAR_key_name" >> $GITHUB_ENV
            echo "TF_VAR_github_repo=$TF_VAR_github_repo" >> $GITHUB_ENV
            echo "TF_VAR_app_port=$TF_VAR_app_port" >> $GITHUB_ENV
            echo "TF_VAR_aws_region=$TF_VAR_aws_region" >> $GITHUB_ENV
          else
            echo "VAULT_ADDR not set; aborting"
            exit 1
          fi

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: 1.5.7

      - name: Terraform plan
        working-directory: ${{ env.TF_DIR }}
        run: |
          terraform init -input=false
          terraform plan -input=false -out=plan.tfplan \
            -var="public_key_path=/tmp/deploy_key.pub" \
            -var="github_repo=${{ env.TF_VAR_github_repo }}" \
            -var="key_name=${{ env.TF_VAR_key_name }}" \
            -var="app_port=${{ env.TF_VAR_app_port:-8000 }}" \
            -var="aws_region=${{ env.TF_VAR_aws_region:-us-east-1 }}" \
            -var="aws_access_key_id=${{ env.AWS_ACCESS_KEY_ID }}" \
            -var="aws_secret_access_key=${{ env.AWS_SECRET_ACCESS_KEY }}"
          terraform show -json plan.tfplan > plan.json || true

      - name: Upload plan artifact
        uses: actions/upload-artifact@v4
        with:
          name: terraform-plan
          path: |
            ${TF_DIR}/plan.tfplan
            ${TF_DIR}/plan.json

  apply:
    name: Terraform apply (manual dispatch)
    runs-on: ubuntu-latest
    needs: plan
    if: ${{ github.event_name == 'workflow_dispatch' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install deps (curl jq)
        run: |
          sudo apt-get update
          sudo apt-get install -y curl jq

      - name: Fetch secrets from Vault (AppRole)
        env:
          VAULT_ADDR: ${{ secrets.VAULT_ADDR }}
          VAULT_ROLE_ID: ${{ secrets.VAULT_ROLE_ID }}
          VAULT_SECRET_ID: ${{ secrets.VAULT_SECRET_ID }}
        run: |
          resp=$(curl -s -X POST "$VAULT_ADDR/v1/auth/approle/login" -d "{\"role_id\":\"${VAULT_ROLE_ID}\",\"secret_id\":\"${VAULT_SECRET_ID}\"}")
          token=$(echo "$resp" | jq -r '.auth.client_token // empty')
          if [ -z "$token" ]; then echo "Vault login failed: $resp" && exit 1; fi
          secret_json=$(curl -s -H "X-Vault-Token: $token" "$VAULT_ADDR/v1/secret/data/figma-web-matcher/ci")
          export AWS_ACCESS_KEY_ID=$(echo "$secret_json" | jq -r '.data.data.AWS_ACCESS_KEY_ID // empty')
          export AWS_SECRET_ACCESS_KEY=$(echo "$secret_json" | jq -r '.data.data.AWS_SECRET_ACCESS_KEY // empty')
          export TF_PUB_KEY=$(echo "$secret_json" | jq -r '.data.data.TF_PUB_KEY // empty')
          export TF_VAR_key_name=$(echo "$secret_json" | jq -r '.data.data.TF_VAR_key_name // empty')
          export TF_VAR_github_repo=$(echo "$secret_json" | jq -r '.data.data.TF_VAR_github_repo // empty')
          export TF_VAR_app_port=$(echo "$secret_json" | jq -r '.data.data.TF_VAR_app_port // empty')
          export TF_VAR_aws_region=$(echo "$secret_json" | jq -r '.data.data.TF_VAR_aws_region // empty')
          echo "$TF_PUB_KEY" > /tmp/deploy_key.pub
          echo "AWS_ACCESS_KEY_ID=$AWS_ACCESS_KEY_ID" >> $GITHUB_ENV
          echo "AWS_SECRET_ACCESS_KEY=$AWS_SECRET_ACCESS_KEY" >> $GITHUB_ENV
          echo "TF_VAR_key_name=$TF_VAR_key_name" >> $GITHUB_ENV
          echo "TF_VAR_github_repo=$TF_VAR_github_repo" >> $GITHUB_ENV
          echo "TF_VAR_app_port=$TF_VAR_app_port" >> $GITHUB_ENV
          echo "TF_VAR_aws_region=$TF_VAR_aws_region" >> $GITHUB_ENV

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: 1.5.7

      - name: Terraform apply
        working-directory: ${{ env.TF_DIR }}
        run: |
          terraform init -input=false
          terraform apply -input=false -auto-approve \
            -var="public_key_path=/tmp/deploy_key.pub" \
            -var="github_repo=${{ env.TF_VAR_github_repo }}" \
            -var="key_name=${{ env.TF_VAR_key_name }}" \
            -var="app_port=${{ env.TF_VAR_app_port:-8000 }}" \
            -var="aws_region=${{ env.TF_VAR_aws_region:-us-east-1 }}" \
            -var="aws_access_key_id=${{ env.AWS_ACCESS_KEY_ID }}" \
            -var="aws_secret_access_key=${{ env.AWS_SECRET_ACCESS_KEY }}"
          terraform output -json > tf_outputs.json
          cat tf_outputs.json
          echo "PUBLIC_IP: $(jq -r '.public_ip.value' tf_outputs.json || true)"
          echo "APP_URL: $(jq -r '.app_url.value' tf_outputs.json || true)"

      - name: Upload outputs artifact
        uses: actions/upload-artifact@v4
        with:
          name: terraform-outputs
          path: terraform/tf_outputs.json